{% extends 'base.html' %}

{% block title %}Dashboard - Injection Moulding System{% endblock %}

{% block content %}
<h2>ğŸ¯ Dashboard</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; opacity: 0.2;">ğŸ­</div>
        <h3 style="color: white; position: relative; z-index: 1;">Active Moulds</h3>
        <p style="font-size: 48px; font-weight: 700; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ active_moulds }}</p>
        <a href="{% url 'mould_run_create' %}" style="position: relative; z-index: 1; color: white; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">â• Start New Run</a>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; opacity: 0.2;">ğŸ“‹</div>
        <h3 style="color: white; position: relative; z-index: 1;">Pending Orders</h3>
        <p style="font-size: 48px; font-weight: 700; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ pending_orders.count }}</p>
        {% if urgent_orders > 0 %}
        <span style="position: relative; z-index: 1; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 15px; font-size: 12px; display: inline-block; margin-top: 10px;">ğŸ”¥ {{ urgent_orders }} URGENT</span>
        {% endif %}
        <a href="{% url 'production_order_create' %}" style="position: relative; z-index: 1; color: white; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">â• New Order</a>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; opacity: 0.2;">âš ï¸</div>
        <h3 style="color: white; position: relative; z-index: 1;">Open Issues</h3>
        <p style="font-size: 48px; font-weight: 700; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ open_issues }}</p>
        {% if critical_issues > 0 %}
        <span style="position: relative; z-index: 1; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 15px; font-size: 12px; display: inline-block; margin-top: 10px;">ğŸš¨ {{ critical_issues }} CRITICAL</span>
        {% endif %}
        <a href="{% url 'issue_create' %}" style="position: relative; z-index: 1; color: white; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">â• Report Issue</a>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; opacity: 0.2;">ğŸ§¹</div>
        <h3 style="color: white; position: relative; z-index: 1;">Housekeeping</h3>
        <p style="font-size: 48px; font-weight: 700; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ active_housekeeping }}</p>
        {% if pending_housekeeping > 0 %}
        <span style="position: relative; z-index: 1; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 15px; font-size: 12px; display: inline-block; margin-top: 10px;">ğŸ“‹ {{ pending_housekeeping }} PENDING</span>
        {% endif %}
        <a href="{% url 'housekeeping_create' %}" style="position: relative; z-index: 1; color: white; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">â• Start Task</a>
    </div>
</div>

<h3 style="margin-top: 40px;">ğŸŸ¢ Active Mould Runs</h3>
{% if active_runs %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
    {% for run in active_runs %}
    <div class="card" style="border-left: 5px solid #11998e;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div>
                <h4 style="color: #11998e; margin-bottom: 5px;">ğŸ­ {{ run.mould }}</h4>
                <p style="color: #666; font-size: 14px; margin: 0;">Machine: <strong>{{ run.machine_number }}</strong></p>
            </div>
            <span class="badge badge-success" style="animation: pulse 2s infinite;">â— ACTIVE</span>
        </div>
        
        <div style="background: rgba(17, 153, 142, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <p style="margin: 5px 0;"><strong>ğŸ‘¤ Setter:</strong> {{ run.setter_name }}</p>
            <p style="margin: 5px 0;"><strong>ğŸ• Started:</strong> {{ run.start_time|date:"Y-m-d H:i" }}</p>
            <p style="margin: 5px 0;"><strong>âœ… Setter Done:</strong> {{ run.setter_completion_time|date:"Y-m-d H:i" }}</p>
            <p style="margin: 5px 0;"><strong>â±ï¸ Running:</strong> {{ run.duration_display }}</p>
        </div>
        
        {% if run.notes %}
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ğŸ“ {{ run.notes }}</p>
        {% endif %}
        
        <a href="{% url 'mould_run_stop' run.pk %}" class="btn btn-danger" style="width: 100%; text-align: center;">â¹ï¸ Stop Run</a>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <div style="font-size: 64px; margin-bottom: 15px;">ğŸ­</div>
    <p style="color: #999; margin-bottom: 20px;">No active mould runs</p>
    <a href="{% url 'mould_run_create' %}" class="btn btn-success">ğŸš€ Start New Run</a>
</div>
{% endif %}

<h3 style="margin-top: 40px;">ğŸ“‹ Pending Production Orders</h3>
{% if pending_orders %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
    {% for order in pending_orders %}
    <div class="card" style="border-left: 5px solid {{ order.priority_display_color }};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div>
                <h4 style="color: #667eea; margin-bottom: 5px;">ğŸ“¦ {{ order.product_name }}</h4>
                <p style="color: #666; font-size: 14px; margin: 0;">Order: <strong>{{ order.order_number }}</strong></p>
            </div>
            <span class="badge" style="background: {{ order.priority_display_color }}; color: white;">
                {% if order.priority == 'urgent' %}ğŸ”¥{% elif order.priority == 'high' %}âš¡{% elif order.priority == 'normal' %}âœ“{% else %}ğŸ“Œ{% endif %}
                {{ order.get_priority_display|upper }}
            </span>
        </div>
        
        <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <p style="margin: 5px 0;"><strong>ğŸ‘¤ Customer:</strong> {{ order.customer_name }}</p>
            <p style="margin: 5px 0;"><strong>ğŸ­ Mould:</strong> {{ order.mould }}</p>
            <p style="margin: 5px 0;"><strong>ğŸ“Š Quantity:</strong> {{ order.quantity_ordered }} {{ order.unit }}</p>
            <p style="margin: 5px 0;"><strong>ğŸ“… Due Date:</strong> {{ order.due_date|date:"Y-m-d" }}
                {% if order.is_overdue %}
                <span class="badge badge-danger">OVERDUE</span>
                {% elif order.days_until_due <= 3 %}
                <span class="badge badge-warning">{{ order.days_until_due }} days</span>
                {% endif %}
            </p>
        </div>
        
        {% if order.special_requirements %}
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">âš ï¸ {{ order.special_requirements|truncatewords:15 }}</p>
        {% endif %}
        
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'production_order_detail' order.pk %}" class="btn" style="flex: 1; text-align: center; padding: 8px;">View</a>
            <a href="{% url 'production_order_update_status' order.pk 'in_progress' %}" class="btn btn-success" style="flex: 1; text-align: center; padding: 8px;">â–¶ï¸ Start</a>
        </div>
    </div>
    {% endfor %}
</div>
<div style="text-align: center; margin: 20px 0;">
    <a href="{% url 'production_order_list' %}" class="btn">View All Orders â†’</a>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“‹</div>
    <p style="color: #999; margin-bottom: 20px;">No pending production orders</p>
    <a href="{% url 'production_order_create' %}" class="btn btn-success">â• Create First Order</a>
</div>
{% endif %}

<h3 style="margin-top: 40px;">âš¡ Quick Actions</h3>
<div style="margin: 20px 0; display: flex; gap: 15px; flex-wrap: wrap;">
    <a href="{% url 'mould_change_create' %}" class="btn" style="flex: 1; min-width: 200px; text-align: center;">
        ğŸ”„ Schedule Mould Change
    </a>
    <a href="{% url 'checklist_create' %}" class="btn btn-success" style="flex: 1; min-width: 200px; text-align: center;">
        âœ… Submit Hourly Checklist
    </a>
    <a href="{% url 'product_comparison_create' %}" class="btn btn-warning" style="flex: 1; min-width: 200px; text-align: center;">
        ğŸ“¸ Compare Product
    </a>
    <a href="{% url 'troubleshooting_log_create' %}" class="btn btn-danger" style="flex: 1; min-width: 200px; text-align: center;">
        ğŸ”§ Log Issue
    </a>
</div>

<h3 style="margin-top: 40px;">âš ï¸ Open Issues</h3>
{% if open_issues_list %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
    {% for issue in open_issues_list %}
    <div class="card" style="border-left: 5px solid {{ issue.priority_color }};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div>
                <h4 style="color: #667eea; margin-bottom: 5px;">{{ issue.title }}</h4>
                <p style="color: #666; font-size: 14px; margin: 0;">{{ issue.issue_number }}</p>
            </div>
            <span class="badge" style="background: {{ issue.priority_color }}; color: white;">
                {% if issue.priority == 'critical' %}ğŸš¨{% elif issue.priority == 'high' %}âš¡{% elif issue.priority == 'medium' %}âš ï¸{% else %}ğŸ“Œ{% endif %}
                {{ issue.get_priority_display|upper }}
            </span>
        </div>
        
        <div style="background: rgba(235, 51, 73, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <p style="margin: 5px 0;"><strong>ğŸ“‚ Category:</strong> {{ issue.category.get_category_type_display }}</p>
            {% if issue.customer_name %}
            <p style="margin: 5px 0;"><strong>ğŸ‘¤ Customer:</strong> {{ issue.customer_name }}</p>
            {% endif %}
            {% if issue.mould %}
            <p style="margin: 5px 0;"><strong>ğŸ­ Mould:</strong> {{ issue.mould }}</p>
            {% endif %}
            {% if issue.machine_number %}
            <p style="margin: 5px 0;"><strong>ğŸ”§ Machine:</strong> {{ issue.machine_number }}</p>
            {% endif %}
            <p style="margin: 5px 0;"><strong>â±ï¸ Open For:</strong> {{ issue.time_open }}</p>
            <p style="margin: 5px 0;"><strong>ğŸ“… Reported:</strong> {{ issue.reported_date|date:"Y-m-d H:i" }}</p>
        </div>
        
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">{{ issue.description|truncatewords:20 }}</p>
        
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'issue_detail' issue.pk %}" class="btn" style="flex: 1; text-align: center; padding: 8px;">View</a>
            {% if issue.status == 'open' %}
            <a href="{% url 'issue_update_status' issue.pk 'in_progress' %}" class="btn btn-warning" style="flex: 1; text-align: center; padding: 8px;">â–¶ï¸ Start</a>
            {% elif issue.status == 'in_progress' %}
            <a href="{% url 'issue_resolve' issue.pk %}" class="btn btn-success" style="flex: 1; text-align: center; padding: 8px;">âœ… Resolve</a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
<div style="text-align: center; margin: 20px 0;">
    <a href="{% url 'issue_list' %}" class="btn">View All Issues â†’</a>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <div style="font-size: 64px; margin-bottom: 15px;">âœ…</div>
    <p style="color: #999; margin-bottom: 20px;">No open issues - Great job!</p>
    <a href="{% url 'issue_create' %}" class="btn btn-danger">Report Issue</a>
</div>
{% endif %}

<h3 style="margin-top: 40px;">ğŸ“‹ Recent Checklists</h3>
<table>
    <thead>
        <tr>
            <th>Machine</th>
            <th>Mould</th>
            <th>Operator</th>
            <th>Time</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for checklist in recent_checklists %}
        <tr>
            <td><strong>{{ checklist.machine_number }}</strong></td>
            <td>{{ checklist.mould }}</td>
            <td>ğŸ‘¤ {{ checklist.operator.username }}</td>
            <td>ğŸ• {{ checklist.check_time|date:"Y-m-d H:i" }}</td>
            <td>
                {% if checklist.issues_found %}
                <span class="badge badge-danger">âš ï¸ Issues Found</span>
                {% else %}
                <span class="badge badge-success">âœ“ OK</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                No checklists yet - Start by submitting your first checklist!
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}
